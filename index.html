<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intesa Vincente - L'Ultima Catena</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        :root {
            --primary: #1a237e;
            --secondary: #d32f2f;
            --accent: #ffab00;
            --success: #4caf50;
            --danger: #f44336;
            --info: #2196f3;
            --warning: #ff9800;
            --dark: #0d1426;
            --light: #f8f9fa;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow: auto;
            font-size: 14px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            text-align: center;
            margin-bottom: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            border: 2px solid var(--accent);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        h1 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 8px;
            font-weight: 800;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        .subtitle {
            font-size: 0.9rem;
            color: var(--secondary);
            font-weight: 600;
        }
        
        /* Schermata di Transizione */
        .transition-screen {
            text-align: center;
            padding: 20px 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            margin: 10px;
            border: 2px solid var(--accent);
        }
        .transition-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .team-selection {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .team-option {
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            border: 3px solid var(--info);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 200px;
            text-align: center;
        }
        .team-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .team-option.selected {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
            transform: scale(1.05);
        }
        .team-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
        }
        .money-input-container {
            margin: 15px 0;
            text-align: left;
        }
        .money-input-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid var(--info);
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            font-weight: 500;
        }
        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 8px rgba(255, 171, 0, 0.3);
        }
        .total-display {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, var(--gold), var(--warning));
            border-radius: 10px;
            border: 2px solid var(--accent);
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        button {
            padding: 12px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            margin: 10px auto;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .start-btn {
            background: linear-gradient(135deg, var(--success), #2e7d32);
            color: white;
        }
        
        /* Gioco Finale - L'Ultima Catena */
        .final-game-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 15px;
            color: white;
        }
        .final-game-content {
            background: rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 15px;
            border: 3px solid rgba(253, 187, 45, 0.5);
            text-align: center;
            max-width: 900px;
            width: 95%;
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }
        .final-game-title {
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 20px;
            font-weight: 800;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
        }
        .final-game-subtitle {
            font-size: 1.4rem;
            margin-bottom: 25px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .final-game-info {
            font-size: 1rem;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-align: left;
        }
        .prize-display {
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 20px;
            background: rgba(46, 204, 113, 0.4);
            border-radius: 12px;
            border: 3px solid var(--success);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .player-turn {
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .chain-display {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .chain-word {
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chain-word.revealed {
            background: linear-gradient(135deg, rgba(253, 187, 45, 0.6), rgba(253, 187, 45, 0.3));
            border-left: 4px solid var(--accent);
            transform: translateX(4px);
        }
        .chain-word.hidden {
            background: linear-gradient(135deg, rgba(178, 31, 31, 0.4), rgba(178, 31, 31, 0.2));
            border-left: 4px solid var(--secondary);
            color: transparent;
        }
        .chain-word.partial {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.4), rgba(41, 128, 185, 0.2));
            border-left: 4px solid var(--info);
        }
        .chain-word.current {
            box-shadow: 0 0 15px rgba(253, 187, 45, 0.8);
            transform: scale(1.02);
        }
        .letter-reveal {
            font-size: 1.4rem;
            margin: 15px 0;
            padding: 15px;
            background: rgba(52, 152, 219, 0.4);
            border-radius: 10px;
            border: 2px solid var(--info);
            font-family: monospace;
            letter-spacing: 3px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .final-timer {
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 20px;
            background: rgba(231, 76, 60, 0.4);
            border-radius: 12px;
            border: 3px solid var(--danger);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .final-game-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .final-game-btn {
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .final-start-btn {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
        }
        .final-jolly-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        .final-answer-btn {
            background: linear-gradient(135deg, var(--info), #2980b9);
            color: white;
        }
        .final-next-btn {
            background: linear-gradient(135deg, var(--accent), #f39c12);
            color: var(--dark);
        }
        .final-game-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        .final-game-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .jolly-counter {
            font-size: 1.1rem;
            margin: 12px 0;
            padding: 12px;
            background: rgba(155, 89, 182, 0.4);
            border-radius: 8px;
            border: 2px solid #9b59b6;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .team-selection {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .team-option {
                width: 100%;
                max-width: 300px;
            }
            
            .final-game-title {
                font-size: 2rem;
            }
            
            .final-game-subtitle {
                font-size: 1.1rem;
            }
            
            .chain-word {
                font-size: 1.1rem;
                padding: 12px;
                min-height: 50px;
            }
            
            .final-game-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .final-timer {
                font-size: 1.6rem;
                padding: 15px;
            }
            
            .final-game-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .final-game-title {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Schermata di Transizione -->
    <div class="container transition-screen" id="transitionScreen">
        <header>
            <h1>ðŸŽ¯ INTESA VINCENTE</h1>
            <p class="subtitle">Quale squadra passa al gioco finale?</p>
        </header>
        
        <div class="transition-content">
            <div class="team-selection">
                <div class="team-option" id="teamAOption" data-team="A">
                    <div class="team-name" id="transitionTeamAName">Squadra A</div>
                    <p>Seleziona per far passare la Squadra A al gioco finale</p>
                </div>
                <div class="team-option" id="teamBOption" data-team="B">
                    <div class="team-name" id="transitionTeamBName">Squadra B</div>
                    <p>Seleziona per far passare la Squadra B al gioco finale</p>
                </div>
            </div>
            
            <div class="money-input-container">
                <label for="initialPrize">Montepremi iniziale (â‚¬):</label>
                <input type="number" id="initialPrize" placeholder="Inserisci il montepremi iniziale" min="0">
            </div>
            
            <div class="money-input-container">
                <label for="intesaVincenteMoney">Somma da Intesa Vincente (â‚¬):</label>
                <input type="number" id="intesaVincenteMoney" placeholder="Inserisci la somma da Intesa Vincente" min="0">
            </div>
            
            <div class="total-display">
                <i class="fas fa-trophy"></i> TOTALE PER L'ULTIMA CATENA: â‚¬<span id="totalForFinalGame">0</span>
            </div>
            
            <button class="start-btn" id="proceedToFinalGameBtn">
                <i class="fas fa-forward"></i> PROCEDI ALL'ULTIMA CATENA
            </button>
        </div>
    </div>

    <!-- Schermata Gioco Finale - L'ULTIMA CATENA -->
    <div class="final-game-screen hidden" id="finalGameScreen">
        <div class="final-game-content">
            <div class="final-game-title">
                <i class="fas fa-trophy"></i> L'ULTIMA CATENA
            </div>
            
            <div class="final-game-subtitle">
                La squadra <span id="winningTeamName">VINCITRICE</span> gioca per â‚¬<span id="finalPrizeAmount">0</span>!
            </div>
            
            <div class="final-game-info">
                <p><strong>Regole del gioco:</strong></p>
                <p>â€¢ La catena Ã¨ composta da 13 parole. Sono visibili le parole in posizione dispari (1Âª, 3Âª, 5Âª, ...).</p>
                <p>â€¢ Dovete indovinare le 6 parole nascoste in posizione pari (2Âª, 4Âª, 6Âª, ...).</p>
                <p>â€¢ Ogni errore dimezza il montepremi.</p>
                <p>â€¢ Avete 2 jolly a disposizione che rivelano una lettera senza penalitÃ .</p>
                <p>â€¢ Senza jolly, ogni errore dimezza il premio e rivela una lettera.</p>
            </div>
            
            <div class="prize-display" id="finalPrizeDisplay">
                Montepremi attuale: â‚¬<span id="currentPrize">0</span>
            </div>
            
            <div class="jolly-counter">
                <i class="fas fa-star"></i> JOLLY DISPONIBILI: <span id="jollyCount">2</span>
            </div>
            
            <div class="player-turn" id="playerTurnDisplay">
                Turno di: <span id="currentPlayer">Giocatore 1</span>
            </div>
            
            <div class="chain-display" id="chainDisplay">
                <!-- Le parole della catena verranno inserite qui dinamicamente -->
            </div>
            
            <div class="letter-reveal" id="letterRevealDisplay">
                Lettere rivelate: <span id="revealedLetters">X</span>
            </div>
            
            <div class="final-timer" id="finalTimer">
                20
            </div>
            
            <div class="final-game-controls">
                <button class="final-start-btn" id="finalStartBtn">
                    <i class="fas fa-play"></i> INIZIA
                </button>
                <button class="final-jolly-btn" id="finalJollyBtn" disabled>
                    <i class="fas fa-star"></i> USA JOLLY
                </button>
                <button class="final-answer-btn" id="finalAnswerBtn" disabled>
                    <i class="fas fa-bullhorn"></i> RISPOSTA
                </button>
                <button class="final-next-btn" id="finalNextBtn" disabled>
                    <i class="fas fa-forward"></i> PROSSIMA
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali per il gioco finale
        let finalGameActive = false;
        let finalChainWords = [];
        let finalHiddenWords = [];
        let finalCurrentWordIndex = 1;
        let finalPrizePercentage = 100;
        let finalJollyCount = 2;
        let finalCurrentPlayerIndex = 0;
        let finalRevealedLetters = [];
        let finalTimerInterval;
        let finalTimeLeft = 20;
        let winningTeam = '';
        let winningTeamPlayers = [];
        let totalPrize = 0;
        
        // Catene per il gioco finale
        const finalChains = [
            {
                words: ["SAMBA", "CARNEVALE", "COPACABANA", "CAIPIRINHA", "AMAZZONIA", "PALME", "CALCIO", "PELÃ‰", "CARIOCA", "FESTA", "COLORE", "CALORE", "PASSIONE"],
                hiddenWords: [1, 3, 5, 7, 9, 11]
            },
            {
                words: ["DETROIT", "MOTORI", "AUTOMOBILE", "FABBRICA", "LAVORO", "SINDACATO", "GRADO", "CAPITALE", "PIANGE", "TONDO", "128.000"],
                hiddenWords: [1, 3, 5, 7, 9]
            }
        ];
        
        // Elementi DOM
        const transitionScreen = document.getElementById('transitionScreen');
        const finalGameScreen = document.getElementById('finalGameScreen');
        const teamAOption = document.getElementById('teamAOption');
        const teamBOption = document.getElementById('teamBOption');
        const initialPrizeInput = document.getElementById('initialPrize');
        const intesaVincenteInput = document.getElementById('intesaVincenteMoney');
        const totalForFinalGame = document.getElementById('totalForFinalGame');
        const proceedToFinalGameBtn = document.getElementById('proceedToFinalGameBtn');
        
        // Elementi DOM per il gioco finale
        const winningTeamName = document.getElementById('winningTeamName');
        const finalPrizeAmount = document.getElementById('finalPrizeAmount');
        const finalPrizeDisplay = document.getElementById('currentPrize');
        const playerTurnDisplay = document.getElementById('currentPlayer');
        const chainDisplay = document.getElementById('chainDisplay');
        const letterRevealDisplay = document.getElementById('revealedLetters');
        const finalTimer = document.getElementById('finalTimer');
        const finalStartBtn = document.getElementById('finalStartBtn');
        const finalJollyBtn = document.getElementById('finalJollyBtn');
        const finalAnswerBtn = document.getElementById('finalAnswerBtn');
        const finalNextBtn = document.getElementById('finalNextBtn');
        const jollyCount = document.getElementById('jollyCount');
        
        // Event listeners per la selezione della squadra
        teamAOption.addEventListener('click', () => selectTeam('A'));
        teamBOption.addEventListener('click', () => selectTeam('B'));
        
        // Event listener per il calcolo del totale
        initialPrizeInput.addEventListener('input', calculateTotal);
        intesaVincenteInput.addEventListener('input', calculateTotal);
        
        // Event listener per procedere al gioco finale
        proceedToFinalGameBtn.addEventListener('click', proceedToFinalGame);
        
        // Event listeners per il gioco finale
        finalStartBtn.addEventListener('click', startFinalGame);
        finalJollyBtn.addEventListener('click', useJolly);
        finalAnswerBtn.addEventListener('click', showAnswerInput);
        finalNextBtn.addEventListener('click', nextFinalWord);
        
        function selectTeam(team) {
            // Rimuovi la selezione precedente
            teamAOption.classList.remove('selected');
            teamBOption.classList.remove('selected');
            
            // Aggiungi la selezione corrente
            if (team === 'A') {
                teamAOption.classList.add('selected');
                winningTeam = 'A';
            } else {
                teamBOption.classList.add('selected');
                winningTeam = 'B';
            }
            
            // Aggiorna i giocatori della squadra vincente (qui dovresti avere i dati reali)
            winningTeamPlayers = [
                {name: "Giocatore 1", character: "ðŸ‘¨"},
                {name: "Giocatore 2", character: "ðŸ‘©"},
                {name: "Giocatore 3", character: "ðŸ§”"}
            ];
        }
        
        function calculateTotal() {
            const initialPrize = parseInt(initialPrizeInput.value) || 0;
            const intesaVincente = parseInt(intesaVincenteInput.value) || 0;
            const bonus = 20000; // Bonus fisso di â‚¬20.000
            
            totalPrize = initialPrize + intesaVincente + bonus;
            totalForFinalGame.textContent = totalPrize.toLocaleString();
        }
        
        function proceedToFinalGame() {
            if (!winningTeam) {
                alert("Seleziona una squadra per procedere!");
                return;
            }
            
            if (totalPrize <= 0) {
                alert("Inserisci un montepremi valido!");
                return;
            }
            
            // Nascondi la schermata di transizione e mostra il gioco finale
            transitionScreen.classList.add('hidden');
            finalGameScreen.classList.remove('hidden');
            
            // Inizializza il gioco finale
            initFinalGame();
        }
        
        // GIOCO FINALE - L'ULTIMA CATENA
        function initFinalGame() {
            finalGameActive = false;
            
            // Seleziona una catena casuale
            const randomChainIndex = Math.floor(Math.random() * finalChains.length);
            const selectedChain = finalChains[randomChainIndex];
            finalChainWords = selectedChain.words;
            finalHiddenWords = selectedChain.hiddenWords;
            
            // Inizializza le variabili di gioco
            finalCurrentWordIndex = 1;
            finalPrizePercentage = 100;
            finalJollyCount = 2;
            finalCurrentPlayerIndex = 0;
            finalRevealedLetters = [];
            
            // Inizializza le lettere rivelate per ogni parola nascosta
            for (let i = 0; i < finalHiddenWords.length; i++) {
                finalRevealedLetters[i] = [0]; // Solo la prima lettera inizialmente
            }
            
            // Aggiorna l'interfaccia
            updateFinalGameUI();
            
            // Mostra il nome della squadra vincente e il premio
            const winningTeamNameText = winningTeam === 'A' ? 
                document.getElementById('transitionTeamAName').textContent : 
                document.getElementById('transitionTeamBName').textContent;
            winningTeamName.textContent = winningTeamNameText;
            finalPrizeAmount.textContent = totalPrize.toLocaleString();
        }
        
        function updateFinalGameUI() {
            // Aggiorna il display del premio
            const currentPrize = Math.floor((finalPrizePercentage / 100) * totalPrize);
            finalPrizeDisplay.textContent = currentPrize.toLocaleString();
            
            // Aggiorna il conteggio dei jolly
            jollyCount.textContent = finalJollyCount;
            finalJollyBtn.disabled = !finalGameActive || finalJollyCount === 0;
            
            // Aggiorna il turno del giocatore
            const currentPlayer = winningTeamPlayers[finalCurrentPlayerIndex];
            playerTurnDisplay.textContent = `${currentPlayer.character} ${currentPlayer.name}`;
            
            // Aggiorna la visualizzazione della catena
            updateChainDisplay();
            
            // Aggiorna le lettere rivelate per la parola corrente
            updateLetterRevealDisplay();
            
            // Aggiorna lo stato dei pulsanti
            finalStartBtn.disabled = finalGameActive;
            finalAnswerBtn.disabled = !finalGameActive;
            finalNextBtn.disabled = !finalGameActive;
        }
        
        function updateChainDisplay() {
            chainDisplay.innerHTML = '';
            
            for (let i = 0; i < finalChainWords.length; i++) {
                const wordElement = document.createElement('div');
                wordElement.className = 'chain-word';
                
                // Controlla se questa Ã¨ una parola nascosta
                if (finalHiddenWords.includes(i)) {
                    // Ãˆ una parola nascosta
                    const hiddenWordIndex = finalHiddenWords.indexOf(i);
                    
                    if (hiddenWordIndex === finalCurrentWordIndex - 1) {
                        // Parola corrente - mostra le lettere rivelate
                        const revealed = finalRevealedLetters[hiddenWordIndex];
                        const word = finalChainWords[i];
                        let displayText = '';
                        
                        for (let j = 0; j < word.length; j++) {
                            if (revealed.includes(j)) {
                                displayText += word[j];
                            } else {
                                displayText += '_';
                            }
                        }
                        
                        wordElement.textContent = displayText;
                        wordElement.classList.add('partial', 'current');
                    } else if (hiddenWordIndex < finalCurrentWordIndex - 1) {
                        // Parola giÃ  indovinata
                        wordElement.textContent = finalChainWords[i];
                        wordElement.classList.add('revealed');
                    } else {
                        // Parola non ancora raggiunta
                        wordElement.textContent = '?';
                        wordElement.classList.add('hidden');
                    }
                } else {
                    // Parola sempre visibile
                    wordElement.textContent = finalChainWords[i];
                    wordElement.classList.add('revealed');
                }
                
                chainDisplay.appendChild(wordElement);
            }
        }
        
        function updateLetterRevealDisplay() {
            if (finalCurrentWordIndex <= finalHiddenWords.length) {
                const hiddenWordIndex = finalCurrentWordIndex - 1;
                const revealed = finalRevealedLetters[hiddenWordIndex];
                const word = finalChainWords[finalHiddenWords[hiddenWordIndex]];
                let displayText = '';
                
                for (let j = 0; j < word.length; j++) {
                    if (revealed.includes(j)) {
                        displayText += word[j];
                    } else {
                        displayText += '_';
                    }
                }
                
                letterRevealDisplay.textContent = displayText;
            } else {
                letterRevealDisplay.textContent = 'Completato!';
            }
        }
        
        function startFinalGame() {
            if (finalGameActive) return;
            
            finalGameActive = true;
            finalTimeLeft = 20;
            finalTimer.textContent = finalTimeLeft;
            
            // Aggiorna l'interfaccia
            updateFinalGameUI();
            
            // Avvia il timer
            startFinalTimer();
        }
        
        function startFinalTimer() {
            clearInterval(finalTimerInterval);
            finalTimerInterval = setInterval(() => {
                finalTimeLeft--;
                finalTimer.textContent = finalTimeLeft;
                
                if (finalTimeLeft <= 0) {
                    clearInterval(finalTimerInterval);
                    handleFinalTimeExpired();
                }
            }, 1000);
        }
        
        function handleFinalTimeExpired() {
            // Tempo scaduto - aggiungi una lettera e passa al giocatore successivo
            revealAdditionalLetter();
            nextPlayer();
            
            // Riprendi il gioco
            finalTimeLeft = 20;
            finalTimer.textContent = finalTimeLeft;
            startFinalTimer();
        }
        
        function useJolly() {
            if (!finalGameActive || finalJollyCount === 0) return;
            
            finalJollyCount--;
            revealAdditionalLetter();
            
            // Aggiorna l'interfaccia
            updateFinalGameUI();
            
            alert('Jolly utilizzato! Una lettera aggiuntiva Ã¨ stata rivelata.');
        }
        
        function revealAdditionalLetter() {
            if (finalCurrentWordIndex > finalHiddenWords.length) return;
            
            const hiddenWordIndex = finalCurrentWordIndex - 1;
            const word = finalChainWords[finalHiddenWords[hiddenWordIndex]];
            const revealed = finalRevealedLetters[hiddenWordIndex];
            
            // Trova la prossima lettera non rivelata
            for (let i = 0; i < word.length; i++) {
                if (!revealed.includes(i)) {
                    revealed.push(i);
                    break;
                }
            }
            
            // Aggiorna l'interfaccia
            updateChainDisplay();
            updateLetterRevealDisplay();
        }
        
        function showAnswerInput() {
            if (!finalGameActive) return;
            
            // Ferma il timer
            clearInterval(finalTimerInterval);
            
            // Mostra un prompt per inserire la risposta
            const answer = prompt("Inserisci la parola nascosta:");
            
            if (answer) {
                checkFinalAnswer(answer.toUpperCase());
            } else {
                // Riprendi il timer se non Ã¨ stata data risposta
                startFinalTimer();
            }
        }
        
        function checkFinalAnswer(answer) {
            const hiddenWordIndex = finalCurrentWordIndex - 1;
            const correctWord = finalChainWords[finalHiddenWords[hiddenWordIndex]];
            
            if (answer === correctWord) {
                // Risposta corretta
                alert(`Esatto! La parola Ã¨ "${correctWord}"`);
                
                // Passa alla parola successiva
                finalCurrentWordIndex++;
                
                // Controlla se il gioco Ã¨ finito
                if (finalCurrentWordIndex > finalHiddenWords.length) {
                    endFinalGame(true);
                } else {
                    // Passa al giocatore successivo
                    nextPlayer();
                    
                    // Riprendi il gioco
                    finalTimeLeft = 20;
                    finalTimer.textContent = finalTimeLeft;
                    startFinalTimer();
                    
                    // Aggiorna l'interfaccia
                    updateFinalGameUI();
                }
            } else {
                // Risposta errata
                if (finalJollyCount > 0) {
                    // Se ci sono jolly disponibili, chiedi se vuoi usarne uno
                    const useJolly = confirm(`Risposta errata! Vuoi usare un jolly per rivelare una lettera senza penalitÃ ?\n\nJolly disponibili: ${finalJollyCount}`);
                    
                    if (useJolly) {
                        useJolly();
                        startFinalTimer(); // Riprendi il timer
                    } else {
                        // Dimezza il premio e aggiungi una lettera
                        handleWrongFinalAnswer();
                    }
                } else {
                    // Nessun jolly disponibile, dimezza il premio
                    handleWrongFinalAnswer();
                }
            }
        }
        
        function handleWrongFinalAnswer() {
            // Dimezza il premio
            finalPrizePercentage = Math.floor(finalPrizePercentage / 2);
            
            // Aggiungi una lettera
            revealAdditionalLetter();
            
            alert(`Risposta errata! Il montepremi si dimezza. La parola corretta era "${finalChainWords[finalHiddenWords[finalCurrentWordIndex - 1]]}"`);
            
            // Passa al giocatore successivo
            nextPlayer();
            
            // Riprendi il gioco
            finalTimeLeft = 20;
            finalTimer.textContent = finalTimeLeft;
            startFinalTimer();
            
            // Aggiorna l'interfaccia
            updateFinalGameUI();
        }
        
        function nextPlayer() {
            finalCurrentPlayerIndex = (finalCurrentPlayerIndex + 1) % winningTeamPlayers.length;
        }
        
        function nextFinalWord() {
            if (!finalGameActive) return;
            
            // Passa alla parola successiva
            finalCurrentWordIndex++;
            
            // Controlla se il gioco Ã¨ finito
            if (finalCurrentWordIndex > finalHiddenWords.length) {
                endFinalGame(false);
            } else {
                // Passa al giocatore successivo
                nextPlayer();
                
                // Aggiorna l'interfaccia
                updateFinalGameUI();
            }
        }
        
        function endFinalGame(isSuccess) {
            finalGameActive = false;
            clearInterval(finalTimerInterval);
            
            // Calcola il premio finale
            const finalPrize = Math.floor((finalPrizePercentage / 100) * totalPrize);
            
            if (isSuccess) {
                alert(`Complimenti! Avete completato la catena e vinto â‚¬${finalPrize.toLocaleString()}!`);
            } else {
                alert(`Gioco completato! Avete vinto â‚¬${finalPrize.toLocaleString()}.`);
            }
            
            // Torna al menu principale dopo 3 secondi
            setTimeout(() => {
                finalGameScreen.classList.add('hidden');
                transitionScreen.classList.remove('hidden');
                resetFinalGame();
            }, 3000);
        }
        
        function resetFinalGame() {
            // Reset delle variabili del gioco finale
            finalGameActive = false;
            finalCurrentWordIndex = 1;
            finalPrizePercentage = 100;
            finalJollyCount = 2;
            finalCurrentPlayerIndex = 0;
            finalRevealedLetters = [];
            finalTimeLeft = 20;
            
            // Reset degli input
            initialPrizeInput.value = '';
            intesaVincenteInput.value = '';
            totalForFinalGame.textContent = '0';
            
            // Deseleziona la squadra
            teamAOption.classList.remove('selected');
            teamBOption.classList.remove('selected');
            winningTeam = '';
        }
        
        // Inizializzazione
        window.addEventListener('load', () => {
            // Seleziona la Squadra A di default
            selectTeam('A');
        });
    </script>
</body>
</html>
